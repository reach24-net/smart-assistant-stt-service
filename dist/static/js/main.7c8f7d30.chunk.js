(this["webpackJsonpreach24-ui-demo"]=this["webpackJsonpreach24-ui-demo"]||[]).push([[0],{46:function(e,t,n){},47:function(e,t,n){},48:function(e,t,n){},49:function(e,t,n){},50:function(e,t,n){},51:function(e,t,n){},75:function(e,t){},78:function(e,t,n){},79:function(e,t,n){},80:function(e,t,n){"use strict";n.r(t);var o=n(1),i=n.n(o),c=n(37),s=n.n(c),a=n(4),r={SET_SESSION:"DialogFlow_SET_SESSION",SET_MESSAGES:"DialogFlow_SET_MESSAGES",ADD_MESSAGES:"DialogFlow_ADD_MESSAGES",SHOULD_LISTEN:"DialogFlow_SHOULD_LISTEN",SET_IS_MUTED:"DialogFlow_SET_IS_MUTED",SET_MICROPHONE:"DialogFlow_SET_MICROPHONE",SET_DISABLED:"DialogFlow_SET_DISABLED",ERROR_DATA:"DialogFlow_ERROR_DATA",RESET_ALL:"DialogFlow_RESET_ALL"},l=n(38),u=n(2),d={disabled:!1,error:null,muted:!1,microphone:!1,session:null,messages:[],shouldListen:!0},h=function(e,t){switch(t.type){case r.RESET_ALL:return Object(u.a)({},d);case r.SET_SESSION:return Object(u.a)(Object(u.a)({},e),{},{session:t.data});case r.SET_MICROPHONE:return Object(u.a)(Object(u.a)({},e),{},{microphone:t.data});case r.SET_IS_MUTED:return Object(u.a)(Object(u.a)({},e),{},{muted:t.data});case r.SET_DISABLED:return Object(u.a)(Object(u.a)({},e),{},{disabled:t.data});case r.SET_MESSAGES:return Object(u.a)(Object(u.a)({},e),{},{messages:t.data});case r.ADD_MESSAGES:return Object(u.a)(Object(u.a)({},e),{},{messages:[].concat(Object(l.a)(e.messages),[t.data])});case r.SHOULD_LISTEN:return Object(u.a)(Object(u.a)({},e),{},{shouldListen:t.data});default:return e}},f=n(0),p={disabled:!1,error:null,muted:!1,microphone:!1,session:null,messages:[],shouldListen:!0},m=i.a.createContext(),v=function(e){var t=Object(o.useReducer)(h,p),n=Object(a.a)(t,2),i=n[0],c=n[1],s={resetAll:function(){c({type:r.RESET_ALL})},setSession:function(e){c({type:r.SET_SESSION,data:e})},addMessage:function(e){c({type:r.ADD_MESSAGES,data:e})},addMessages:function(e){c({type:r.SET_MESSAGES,data:e})},setShouldListen:function(e){c({type:r.SHOULD_LISTEN,data:e})},setDisabled:function(e){c({type:r.SET_DISABLED,data:e})},setMicrophone:function(e){c({type:r.SET_MICROPHONE,data:e})},setIsMuted:function(e){c({type:r.SET_IS_MUTED,data:e})},setError:function(e){c({type:r.ERROR_DATA,data:e})}};return Object(f.jsx)(m.Provider,{value:{contextState:i,contextActions:s},children:e.children})},b=n(3),j=n.n(b),O=n(10),g=n(82);n(46),n(47);function S(){return Object(f.jsxs)("div",{className:"welcome-view",children:[Object(f.jsx)("img",{className:"agent-icon",src:"https://prescienceds.com/wp-content/uploads/2020/09/logo_main.png",alt:"Olivia"}),Object(f.jsx)("div",{className:"agent-title",children:"Olivia"})]})}var E=i.a.memo(S);n(48);function x(e){var t=e.children;return Object(f.jsxs)("header",{className:"top-head",children:[Object(f.jsxs)("div",{className:"top-head-container",children:[Object(f.jsx)("img",{className:"top-head-icon",src:"https://prescienceds.com/wp-content/uploads/2020/08/cropped-favicon-180x180.png",alt:"Olivia"}),Object(f.jsxs)("div",{className:"top-head-info",children:[Object(f.jsx)("div",{className:"top-head-title",children:"Olivia"}),Object(f.jsxs)("div",{className:"top-head-subtitle",children:["Built by",Object(f.jsx)("a",{target:"_blank",rel:"noopener noreferrer",href:"https://prescienceds.com/","aria-hidden":"true",children:"\xa0Prescience"})]})]})]}),Object(f.jsx)("div",{children:t})]})}var _=i.a.memo(x);n(49);function k(e){var t=e.title,n=void 0===t?"":t,o=e.icon,i=void 0===o?"":o,c=e.toggle;return Object(f.jsx)("button",{className:"top-head-action",title:n,"aria-label":n,onClick:c,children:Object(f.jsx)("i",{"aria-hidden":"true",className:"material-icons",children:i})})}var T=i.a.memo(k);n(50);function D(e){var t=e.message,n=void 0===t?null:t;return Object(f.jsxs)("div",{className:"error-message",children:[Object(f.jsx)("i",{className:"material-icons error-message-icon","aria-hidden":"true",children:"error"}),Object(f.jsx)("div",{className:"error-message-description",children:n})]})}var w,y,M,I,N,A,R=i.a.memo(D),C=n(7),L=n.n(C),U=n(39),P=(n(51),n(8)),G=n(9),F=n(17),H=n.n(F),B={endpoint:"/api",socketEndpoint:"https://proxy-prescience.herokuapp.com/",speechToText:"/",fallback_lang:"en-US",voice:"native",codecs:{OUTPUT_AUDIO_ENCODING_UNSPECIFIED:"audio/wav",OUTPUT_AUDIO_ENCODING_LINEAR_16:"audio/wav",OUTPUT_AUDIO_ENCODING_MP3:"audio/mpeg",OUTPUT_AUDIO_ENCODING_OGG_OPUS:"audio/ogg"},timeout:{afterMessageTextToMicrophone:500,voiceRecognitionEndTimeout:2500}},q={video:!1,audio:{sampleRate:48e3,channelCount:2,volume:1,echoCancellation:!0,noiseSuppression:!0}},Q=function(){function e(){Object(P.a)(this,e),this.socket=null,this.endMicrophoneCallback=null,this.interimResults="",this.query="",this.createSocket(),this.microphoneProcess=this.microphoneProcess.bind(this),this.closeAll=this.closeAll.bind(this),this.stopRecording=this.stopRecording.bind(this),this.getQuery=this.getQuery.bind(this),this.submit=null}return Object(G.a)(e,[{key:"setText",value:function(e,t){var n=this.query;return t?(e&&" "===e[0]?n+=e:n=n+" "+e,this.interimResults="",this.query=n):this.interimResults=e,n}},{key:"getQuery",value:function(){return this.query}},{key:"microphoneProcess",value:function(e){var t=e.inputBuffer.getChannelData(0),n=this.convertFloat32ToInt16(t);this.socket.emit("binaryAudioData",n)}},{key:"createSocket",value:function(){var e=new H.a.connect(B.speechToText,{transports:["websocket"]});this.socket=e}},{key:"initRecording",value:function(e,t,n,o){var i=this;this.endMicrophoneCallback=t;var c=this.stopRecording,s=this.microphoneProcess,a=this.getQuery;this.socket.emit("startGoogleCloudStream"),w=window.AudioContext||window.webkitAudioContext,y=new w,(M=y.createScriptProcessor(2048,1,1)).connect(y.destination),y.resume();navigator.mediaDevices.getUserMedia(q).then((function(e){y&&(A=e,(I=y.createMediaStreamSource(e)).connect(M),console.log("handleSuccess"),N=setTimeout((function(){console.log("stopped without speaking timeoutEnd"),c()}),7e3),M.onaudioprocess=function(e){s(e)})})),e&&(this.socket.on("speechData",(function(t){console.log("speechData",null===t||void 0===t?void 0:t.privText);var o=i.setText(null===t||void 0===t?void 0:t.privText,!0);e(o,!0),clearTimeout(N),N=setTimeout((function(){n(a()),c()}),B.timeout.voiceRecognitionEndTimeout)})),this.socket.on("speechDataInterim",(function(t){var n,o,c;console.log("speechDataInterim",null===t||void 0===t||null===(n=t.privResult)||void 0===n?void 0:n.privText),i.setText(null===t||void 0===t||null===(o=t.privResult)||void 0===o?void 0:o.privText,!1),e(null===t||void 0===t||null===(c=t.privResult)||void 0===c?void 0:c.privText,!1),N&&clearTimeout(N)}))),this.socket.on("googleCloudStreamError",(function(e){o&&o("error"),i.stopRecording()})),this.socket.on("endGoogleCloudStream",(function(){i.stopRecording()}))}},{key:"closeAll",value:function(){console.log("closeAll started"),this.socket.off("speechData"),this.socket.off("speechDataInterim"),this.socket.off("googleCloudStreamError"),N&&clearTimeout(N),this.socket.destroy();var e=A?A.getTracks():null,t=e?e[0]:null;if(t&&t.stop(),M){if(I)try{I.disconnect(M)}catch(n){console.warn("Attempt to disconnect input failed.")}y&&M.disconnect(y.destination)}y&&y.close().then((function(){I=null,M=null,y=null,w=null})),this.socket.on("disconnect"),this.endMicrophoneCallback()}},{key:"stopRecording",value:function(){this.socket.emit("endGoogleCloudStream"),this.closeAll()}},{key:"convertFloat32ToInt16",value:function(e){for(var t=e.length,n=new Int16Array(t/3);t--;)t%3===0&&(n[t/3]=65535*e[t]);return n.buffer}}]),e}();window.MediaRecorder=U.a;var z=null;function J(e){var t=this,n=e.submit,o=e.stopOthersSound,c=i.a.useState(""),s=Object(a.a)(c,2),r=s[0],l=s[1],u=i.a.useState(""),d=Object(a.a)(u,2),h=d[0],p=d[1],v=i.a.useContext(m),b=v.contextActions,g=v.contextState,S=g.shouldListen,E=g.disabled,x=void 0!==E&&E,_=g.microphone,k=function(){var e=Object(O.a)(j.a.mark((function e(){var n,i,c=arguments;return j.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c.length>0&&void 0!==c[0]&&c[0]?(n=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e&&(t?(l(""),p((function(t){return t+e}))):l(e))},i=function(){z=null,b.setMicrophone(!1),k(!1)},o(),z=new Q,b.setMicrophone(!0),z.initRecording(n.bind(t),i,T,(function(e){console.error("Error when transcribing",e),b.setMicrophone(!1)}))):(_&&b.setMicrophone(!1),z&&z.stopRecording());case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),T=function(e){D({text:e})},D=function(e){p(""),l(""),e.text&&e.text.length>0&&n({type:"text",payload:e})};i.a.useEffect((function(){S&&(_?(k(!0),p("")):k(!1))}),[_]);var w=i.a.useMemo((function(){return window.webkitSpeechRecognition||window.SpeechRecognition||!window.MediaRecorder.notSupported}),[]);return Object(f.jsx)("div",{className:"chat-field",children:Object(f.jsx)("div",{className:"chat-field-container",children:Object(f.jsxs)("div",{className:"chat-field-flexible",children:[Object(f.jsx)("input",{value:h+r,className:"chat-field-input",type:"text",autoFocus:!0,placeholder:"Message","aria-label":"Message",disabled:x,onKeyDown:function(e){"Enter"===e.code&&D({text:h})},onFocus:function(e){k(!1),o()},onChange:function(e){p(e.target.value)}}),Object(f.jsx)("div",{name:"chat-field-button-animation",mode:"out-in",children:!_&&h.length>0||!w?Object(f.jsx)("button",{className:"chat-field-action",title:"Send","aria-label":"Send",disabled:x,onClick:function(){D({text:h})},children:Object(f.jsx)("i",{className:"material-icons","aria-hidden":"true",children:"arrow_upward"})},"send"):Object(f.jsx)(f.Fragment,{children:Object(f.jsx)("button",{className:L()("chat-field-action",{mic_active:Boolean(_)}),"aria-label":"Voice Input",title:"Voice Input",disabled:x,onClick:function(){!1===S&&!1===_&&b.setShouldListen(!0),b.setMicrophone(!_)},children:Object(f.jsx)("i",{className:"material-icons","aria-hidden":"true",children:"mic"})},"microphone")})})]})})})}var V=i.a.memo(J);n(78);function K(e){var t=e.me,n=e.fullwidth,o=e.children;return Object(f.jsx)("div",{className:L()("rich-component",{me:t,fullwidth:n}),children:o})}var W=i.a.memo(K);n(79);function X(e){var t=e.text,n=void 0===t?"":t,o=e.me,i=e.loading;return Object(f.jsx)("div",{className:L()("rich-bubble",{me:o,loading:i}),tabIndex:"0",children:n})}var Y=i.a.memo(X),Z=new Audio,$=[],ee={name:"Mark"};var te=function(e){var t=e.socket,n=i.a.useState(!1),o=Object(a.a)(n,2),c=o[0],s=o[1],r=i.a.useContext(m),l=r.contextState,d=r.contextActions,h=l.session,p=l.messages,v=l.disabled,b=l.shouldListen,S=i.a.useRef(l);i.a.useEffect((function(){S.current=l}),[l]),i.a.useEffect((function(){return t.isInitialized()||x(),function(){t&&t.close()}}),[]);var x=function(){var e=Object(O.a)(j.a.mark((function e(){return j.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.isInitialized()||(t.createSocket(),t.on("bot_uttered",w),t.on("connect",(function(){t.emit("session_request",{session_id:h})})),t.on("session_confirm",(function(e){var n=e&&e.session_id?e.session_id:e;console.log("session_confirm:".concat(t.socket.id," session Id:").concat(n)),d.setSession(t.socket.id),k()})),t.on("disconnect",(function(e){console.log(e),"io client disconnect"!==e&&t.close()})));case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),k=function(){if(h){var e="/greet"+JSON.stringify(ee);M({payload:{text:e}}),s(!0)}},D=function(){window.speechSynthesis&&window.speechSynthesis.cancel(),Z&&!Z.paused&&($.length>0&&$.shift(),Z.pause())},w=function(){var e=Object(O.a)(j.a.mark((function e(t){var n,o,i;return j.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=S.current,o=t.attachment,I(o),n.microphone&&d.setMicrophone(!1),0===$.length?($.push(o),i=$[0],y(i)):$.push(o);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),y=function(){var e=Object(O.a)(j.a.mark((function e(t){var n,o,i,c;return j.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=function(){var e=$[0];e&&y(e)},(n=S.current).muted?($=[],n.shouldListen&&setTimeout((function(){d.setMicrophone(!0)}),B.timeout.afterMessageTextToMicrophone)):t.payload.audioOutput?(i=B.codecs.OUTPUT_AUDIO_ENCODING_UNSPECIFIED,Z.src="data:".concat(i,";base64,").concat(t.payload.audioOutput),Z.onended=function(){$.shift(),0===$.length?n.shouldListen&&setTimeout((function(){d.setMicrophone(!0)}),B.timeout.afterMessageTextToMicrophone):o()},Z.onerror=function(){$.shift()},Z.play()):((c=new SpeechSynthesisUtterance(t.payload.text)).voiceURI=B.voice,c.lang=B.fallback_lang,c.onend=function(){$.shift(),0===$.length?n.shouldListen&&setTimeout((function(){d.setMicrophone(!0)}),B.timeout.afterMessageTextToMicrophone):o()},n.muted||window.speechSynthesis.speak(c));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),M=function(e){h&&(I(e,!0),D(),d.setError(null),console.log("sending payload",e),t.emit("user_uttered",{message:e.payload.text,customData:{language:"en"},session_id:h}))},I=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=Object(u.a)({id:Object(g.a)(),me:t},e);d.addMessage(n)};return Object(f.jsxs)("main",Object(u.a)(Object(u.a)({id:"app"},!c&&{onClick:function(){return k()}}),{},{children:[c&&Object(f.jsxs)(_,{children:[Object(f.jsx)(T,{title:l.muted?"Unmute":"Mute",icon:l.muted?"volume_off":"volume_up",toggle:function(){var e;e=!l.muted,Z.muted=e,e&&D(),d.setIsMuted(e)}}),Object(f.jsx)(T,{title:b?"Hearing Enabled":"Hearing disabled",icon:b?"hearing":"hearing_disabled",toggle:function(){!function(e){d.setShouldListen(e)}(!b)}}),Object(f.jsx)(T,{title:"Reset",icon:"backspace",toggle:function(){D(),d.resetAll(),s(!0),t.close(),x()}})]}),Object(f.jsxs)("section",{className:"chat",children:[l.error&&Object(f.jsx)(R,{message:l.error}),0===p.length?Object(f.jsx)(E,{}):Object(f.jsx)("section",{"aria-live":"polite",children:p.map((function(e){var t,n;return"text"===e.type?Object(f.jsx)(W,{me:null!==(t=e.me)&&void 0!==t&&t,children:e.payload&&Object(f.jsx)(Y,Object(u.a)({me:null!==(n=e.me)&&void 0!==n&&n},e.payload))},e.id):null}))})]}),Object(f.jsx)(V,{submit:M,stopOthersSound:D,disabled:v||!c})]}))};var ne=function(){function e(t,n,o){Object(P.a)(this,e),this.url=t,this.customData=n,this.path=o,this.socket=null,this.onEvents=[],this.marker=Math.random()}return Object(G.a)(e,[{key:"isInitialized",value:function(){return null!==this.socket&&this.socket.connected}},{key:"on",value:function(e,t){this.socket?this.socket.on(e,t):this.onEvents.push({event:e,callback:t})}},{key:"emit",value:function(e,t){this.socket&&this.socket.emit(e,t)}},{key:"close",value:function(){this.socket&&this.socket.close()}},{key:"createSocket",value:function(){var e=this;this.socket=function(e,t,n){var o=n?{path:n}:{},i=H()(e,o);return i.on("connect",(function(){console.log("connect:".concat(i.id)),i.customData=t})),i.on("connect_error",(function(e){console.log(e)})),i.on("error",(function(e){console.log(e)})),i.on("disconnect",(function(e){console.log(e)})),i}(this.url,this.customData,this.path),this.socket.on("session_confirm",(function(t){e.sessionConfirmed=!0,e.sessionId=t&&t.session_id?t.session_id:t})),this.onEvents.forEach((function(t){e.socket.on(t.event,t.callback)})),this.onEvents=[]}}]),e}(),oe=null;function ie(){var e=i.a.useRef({});return e.current.url||oe&&oe.socketRef||(console.log("init socket"),e.current=new ne(B.socketEndpoint,{language:"en"},"/socket.io/")),!e.current.url&&oe&&oe.socketRef&&(e.current=oe.socket),oe||((oe={}).socketRef=e.current.marker,oe.socket=e.current),Object(f.jsx)(te,{socket:e.current})}var ce=i.a.memo(ie);s.a.render(Object(f.jsx)(i.a.StrictMode,{children:Object(f.jsx)(v,{children:Object(f.jsx)(ce,{})})}),document.getElementById("root"))}},[[80,1,2]]]);
//# sourceMappingURL=main.7c8f7d30.chunk.js.map